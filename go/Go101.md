# Go 101
## Memory Block

Memory block là một phân đoạn bộ nhớ liên tục (continous memory segment) để chứa `value parts` ở run time, những block khác nhau có thể có size khác nhau, chứa những value part khác nhau.

Một memory block có thể chứa nhiều value parts cùng lúc, nhưng mỗi value part chỉ nằm trên 1 memory block, dù là size của value part có lớn đến đâu.

Một memory block sẽ được tham chiếu (referenced) bởi tất cả các giá trị mà nó chứa.

**Khi nào thì 1 memory block được cấp phát?**
- khi gọi `new` hoặc là `make`. Khi hàm `new` được gọi thì sẽ luôn cấp 1 memory block. Còn đối với `make` thì có thể sẽ được cấp phát nhiều hơn 1 block, cho direct part và cả underlying part của slice, channel hay map được tạo
- khi khai báo biến
- khi khai báo map, anonymous function, slice literals
- khi assign non-interface values cho interface values (khi mà non-interface value không phải là pointer)
- nối những non-constants strings
- convert strings sang bytes hoặc là rune slices (trừ một vài trường hợp đặc biệt)
- convert integers sang strings
- khi dùng `append` (lúc mà cap của slice không đủ lớn để chứa)
- thêm một cặp key-value vào map (khi mà underlying hashtable cần được resized)

**Memory block được cấp phát trên đâu?**
Ở runtime thì mỗi goroutine sẽ maintain 1 stack, chính là 1 memory segment. Nó hoạt động như một memory pool để cấp phát memory blocks. Mặc định thì size ban đầu của stack là 2KiB (Go ver < 1.19). Và stack sẽ tự động grow và shrink khi cần trong run time.

Ngoài stack thì memory block còn có thể được cấp phát trong heap.

Trong khi stack chỉ available trong local của mỗi routine thì heap là 1 singleton của một program, nên value part trên memory block chứa trong heap có thể được dùng bởi nhiều goroutines.

Nếu chỉ dùng mỗi Heap thì chương trình vẫn chạy được, nhưng Stack giúp cho chương trình hoạt động hiệu quả hơn:
- cấp phát vùng nhớ trên stack nhanh hơn trên heap
- memory block trên stack không cần garbage collected
- stack memory block thân thiện vs CPU cache hơn heap

Nếu một biến local được định nghĩa trong 1 function được cấp phát trên heap thì ta nói là biến đó `escape to heap`.

Một value part được coi là active trên heap nếu nó vẫn còn được sử dụng bởi một value part nằm trong stack.

Ref: https://go101.org/article/memory-block.html

## Value Parts

